{% extends "base.html" %}
{% block page_title %}{{ title }}{% endblock %}
{% block page_subtitle %}{{ 'Edit an existing' if promo else 'Create a new' }} discount promotion{% endblock %}

{% block content %}
{% with messages = get_flashed_messages(with_categories=true) %}
{% for category, message in messages %}
<div
    class="mb-4 px-4 py-3 rounded-lg text-sm {{ 'bg-green-900/50 border border-green-700 text-green-300' if category=='success' else 'bg-red-900/50 border border-red-700 text-red-300' }}">
    {{ message }}
</div>
{% endfor %}
{% endwith %}

<div class="max-w-2xl">
    <form method="POST" class="space-y-5">

        {{-- Name --}}
        <div>
            <label class="block text-xs font-medium text-gray-400 uppercase tracking-wider mb-1.5">
                Promotion Name <span class="text-red-400">*</span>
            </label>
            <input type="text" name="name" required value="{{ promo.name if promo else '' }}"
                placeholder="e.g. Weekend Flash Sale" class="w-full bg-gray-900 border border-gray-700 text-white rounded-lg px-3 py-2.5 text-sm
                    focus:outline-none focus:border-brand-500 transition-colors">
        </div>

        {{-- Type --}}
        <div>
            <label class="block text-xs font-medium text-gray-400 uppercase tracking-wider mb-1.5">
                Promotion Type <span class="text-red-400">*</span>
            </label>
            <select name="promo_type" id="promo_type" required class="w-full bg-gray-900 border border-gray-700 text-white rounded-lg px-3 py-2.5 text-sm
                     focus:outline-none focus:border-brand-500 transition-colors">
                {% for value, label in promo_types %}
                <option value="{{ value }}" {{ 'selected' if promo and promo.promo_type==value }}>
                    {{ label }}
                </option>
                {% endfor %}
            </select>
        </div>

        {{-- Dynamic Params by type --}}
        <div id="params-section" class="bg-gray-900 border border-gray-800 rounded-xl p-4 space-y-4">
            <p class="text-xs text-gray-500 font-medium uppercase tracking-wider mb-2">Promotion Parameters</p>

            {{-- percentage_item & fixed_item share product list --}}
            <div id="param-product_ids" class="space-y-1.5">
                <label class="block text-xs text-gray-400">Product IDs (comma-separated)
                    <span class="text-gray-600 ml-1">e.g. 1, 5, 12</span>
                </label>
                <input type="text" name="param_product_ids"
                    value="{{ (promo.params_dict.get('product_ids', [])|join(', ')) if promo else '' }}"
                    placeholder="3, 14, 27" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 text-sm
                      focus:outline-none focus:border-brand-500">
                <p class="text-xs text-gray-600">Quick pick:</p>
                <div class="flex flex-wrap gap-2 mt-1">
                    {% for product in products %}
                    <button type="button" onclick="appendProductId({{ product.id }})"
                        class="px-2 py-0.5 text-xs bg-gray-700 text-gray-300 rounded hover:bg-gray-600 transition-colors">
                        #{{ product.id }} {{ product.name[:20] }}
                    </button>
                    {% endfor %}
                </div>
            </div>

            <div id="param-percent" class="space-y-1.5">
                <label class="block text-xs text-gray-400">Discount Percent</label>
                <div class="flex items-center gap-2">
                    <input type="number" name="param_percent" min="0" max="100" step="0.01"
                        value="{{ promo.params_dict.get('percent', '') if promo else '' }}" placeholder="10" class="w-40 bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 text-sm
                        focus:outline-none focus:border-brand-500">
                    <span class="text-gray-400 text-sm">%</span>
                </div>
            </div>

            <div id="param-amount" class="space-y-1.5">
                <label class="block text-xs text-gray-400">Fixed Discount Amount</label>
                <div class="flex items-center gap-2">
                    <span class="text-gray-400 text-sm">₹</span>
                    <input type="number" name="param_amount" min="0" step="0.01"
                        value="{{ promo.params_dict.get('amount', '') if promo else '' }}" placeholder="50" class="w-40 bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 text-sm
                        focus:outline-none focus:border-brand-500">
                </div>
            </div>

            <div id="param-bxgy" class="space-y-2">
                <label class="block text-xs text-gray-400">Buy X Get Y — Product ID</label>
                <input type="number" name="param_product_id" min="1"
                    value="{{ promo.params_dict.get('product_id', '') if promo else '' }}" placeholder="Product ID"
                    class="w-40 bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 text-sm
                      focus:outline-none focus:border-brand-500">
                <div class="flex items-center gap-4 mt-2">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Buy Qty</label>
                        <input type="number" name="param_buy_qty" min="1"
                            value="{{ promo.params_dict.get('buy_qty', 2) if promo else 2 }}" class="w-24 bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 text-sm
                          focus:outline-none focus:border-brand-500">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Free Qty</label>
                        <input type="number" name="param_free_qty" min="1"
                            value="{{ promo.params_dict.get('free_qty', 1) if promo else 1 }}" class="w-24 bg-gray-800 border border-gray-700 text-white rounded-lg px-3 py-2 text-sm
                          focus:outline-none focus:border-brand-500">
                    </div>
                </div>
            </div>
        </div>

        {{-- Date range --}}
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-xs font-medium text-gray-400 uppercase tracking-wider mb-1.5">Start Date
                    <span class="text-gray-600">(optional)</span></label>
                <input type="date" name="start_date"
                    value="{{ promo.start_date.isoformat() if promo and promo.start_date else '' }}" class="w-full bg-gray-900 border border-gray-700 text-white rounded-lg px-3 py-2.5 text-sm
                      focus:outline-none focus:border-brand-500">
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-400 uppercase tracking-wider mb-1.5">End Date
                    <span class="text-gray-600">(optional)</span></label>
                <input type="date" name="end_date"
                    value="{{ promo.end_date.isoformat() if promo and promo.end_date else '' }}" class="w-full bg-gray-900 border border-gray-700 text-white rounded-lg px-3 py-2.5 text-sm
                      focus:outline-none focus:border-brand-500">
            </div>
        </div>

        {{-- Max uses --}}
        <div>
            <label class="block text-xs font-medium text-gray-400 uppercase tracking-wider mb-1.5">
                Max Uses <span class="text-gray-600">(blank = unlimited)</span>
            </label>
            <input type="number" name="max_uses" min="1"
                value="{{ promo.max_uses if promo and promo.max_uses else '' }}" placeholder="Leave blank for unlimited"
                class="w-48 bg-gray-900 border border-gray-700 text-white rounded-lg px-3 py-2.5 text-sm
                    focus:outline-none focus:border-brand-500">
        </div>

        {{-- Checkboxes --}}
        <div class="flex items-center gap-8">
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" name="is_active" value="1" {{ 'checked' if (promo is none or promo.is_active) }}
                    class="w-4 h-4 rounded border-gray-600 bg-gray-800 accent-brand-500">
                <span class="text-sm text-white">Active</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" name="stackable" value="1" {{ 'checked' if (promo is none or promo.stackable) }}
                    class="w-4 h-4 rounded border-gray-600 bg-gray-800 accent-brand-500">
                <span class="text-sm text-white">Stackable</span>
                <span class="text-xs text-gray-600">(can combine with other promos)</span>
            </label>
        </div>

        {{-- Actions --}}
        <div class="flex items-center gap-3 pt-2">
            <button type="submit"
                class="px-5 py-2.5 bg-brand-600 hover:bg-brand-700 text-white rounded-lg text-sm font-medium transition-colors">
                {{ 'Save Changes' if promo else 'Create Promotion' }}
            </button>
            <a href="{{ url_for('promotions.index') }}"
                class="px-5 py-2.5 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded-lg text-sm transition-colors">
                Cancel
            </a>
        </div>
    </form>
</div>

<script>
    // Show / hide params sections based on selected type
    const paramMap = {
        percentage_item: ['param-product_ids', 'param-percent'],
        fixed_item: ['param-product_ids', 'param-amount'],
        bill_percentage: ['param-percent'],
        buy_x_get_y: ['param-bxgy'],
    };
    const allSections = ['param-product_ids', 'param-percent', 'param-amount', 'param-bxgy'];

    function updateParams() {
        const type = document.getElementById('promo_type').value;
        const show = new Set(paramMap[type] || []);
        allSections.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.style.display = show.has(id) ? 'block' : 'none';
        });
    }

    function appendProductId(id) {
        const inp = document.querySelector('[name="param_product_ids"]');
        const cur = inp.value.trim();
        const ids = cur ? cur.split(',').map(s => s.trim()).filter(Boolean) : [];
        if (!ids.includes(String(id))) {
            ids.push(String(id));
            inp.value = ids.join(', ');
        }
    }

    document.getElementById('promo_type').addEventListener('change', updateParams);
    updateParams(); // init on load
</script>
{% endblock %}