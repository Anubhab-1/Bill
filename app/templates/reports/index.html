{% extends "base.html" %}

{% block page_title %}Sales Reports{% endblock %}
{% block page_subtitle %}Full transaction history with filters and export{% endblock %}

{% block content %}

{# ── Filter Bar ──────────────────────────────────────────────────── #}
<form method="GET" action="{{ url_for('reports.index') }}"
    class="bg-gray-900 border border-gray-800 rounded-xl p-5 mb-6">
    <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4 items-end">

        {# Start date #}
        <div>
            <label class="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1.5">
                From
            </label>
            <input type="date" name="start" value="{{ start_str }}" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2.5
                    text-sm text-white focus:outline-none focus:ring-2
                    focus:ring-brand-500 focus:border-transparent transition-colors" />
        </div>

        {# End date #}
        <div>
            <label class="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1.5">
                To
            </label>
            <input type="date" name="end" value="{{ end_str }}" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2.5
                    text-sm text-white focus:outline-none focus:ring-2
                    focus:ring-brand-500 focus:border-transparent transition-colors" />
        </div>

        {# Cashier dropdown #}
        <div>
            <label class="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1.5">
                Cashier
            </label>
            <select name="cashier" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2.5
                     text-sm text-white focus:outline-none focus:ring-2
                     focus:ring-brand-500 focus:border-transparent transition-colors">
                <option value="">All Cashiers</option>
                {% for c in cashiers %}
                <option value="{{ c.id }}" {% if cashier_id==c.id %}selected{% endif %}>
                    {{ c.name }}
                </option>
                {% endfor %}
            </select>
        </div>

        {# Action buttons #}
        <div class="flex gap-2">
            <button type="submit" class="flex-1 px-4 py-2.5 bg-brand-600 hover:bg-brand-700 text-white
                     text-sm font-semibold rounded-lg transition-colors">
                Filter
            </button>
            <a href="{{ url_for('reports.index') }}" class="px-4 py-2.5 bg-gray-800 hover:bg-gray-700 text-gray-300
                text-sm font-medium rounded-lg transition-colors">
                Clear
            </a>
        </div>

    </div>
</form>

{# ── Summary KPI Strip ───────────────────────────────────────────── #}
<div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">

    <div class="bg-gray-900 border border-gray-800 rounded-xl px-5 py-4">
        <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">
            Total Transactions
        </p>
        <p class="text-2xl font-bold text-white">{{ total_count }}</p>
    </div>

    <div class="bg-gray-900 border border-gray-800 rounded-xl px-5 py-4">
        <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">
            Total Revenue
        </p>
        <p class="text-2xl font-bold text-brand-400">
            ₹{{ "{:.2f}".format(grand_sum | float) }}
        </p>
    </div>

    <div class="bg-gray-900 border border-gray-800 rounded-xl px-5 py-4">
        <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">
            Avg. Bill Value
        </p>
        <p class="text-2xl font-bold text-white">
            ₹{{ "{:.2f}".format(avg_bill | float) }}
        </p>
    </div>

</div>

{# ── Toolbar: export + cashier summary links ─────────────────────── #}
<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
    <p class="text-sm text-gray-500">
        Showing
        <span class="text-white font-medium">
            {{ (page - 1) * page_size + 1 }}–{{ [page * page_size, total_count] | min }}
        </span>
        of <span class="text-white font-medium">{{ total_count }}</span> sales
        {% if start_str or end_str or cashier_id %}
        <span class="text-gray-600">(filtered)</span>
        {% endif %}
    </p>

    <div class="flex gap-2">
        <a href="{{ url_for('reports.cashier_summary', start=start_str, end=end_str) }}" class="inline-flex items-center gap-2 px-3 py-2 bg-gray-800 hover:bg-gray-700
              text-gray-300 text-xs font-medium rounded-lg transition-colors">
            <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            Cashier Summary
        </a>
        <a href="{{ url_for('reports.export_csv', start=start_str, end=end_str, cashier=cashier_id or '') }}" class="inline-flex items-center gap-2 px-3 py-2 bg-emerald-600/20 hover:bg-emerald-600/30
              text-emerald-400 text-xs font-medium rounded-lg transition-colors border border-emerald-600/30">
            <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
            Export CSV
        </a>
        <a href="{{ url_for('reports.reconciliation') }}"
            class="inline-flex items-center gap-2 px-3 py-2 bg-indigo-500/10 hover:bg-indigo-500/20 text-indigo-400 text-xs font-medium rounded-lg transition-colors border border-indigo-500/20">
            <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
            </svg>
            Reconciliation
        </a>
    </div>
</div>

{# ── Sales Table ─────────────────────────────────────────────────── #}
{% if sales %}
<div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden mb-5">
    <table class="w-full text-sm">
        <thead>
            <tr class="border-b border-gray-800 text-left">
                <th class="px-5 py-3.5 text-xs font-semibold text-gray-400 uppercase tracking-wider">Invoice</th>
                <th class="px-5 py-3.5 text-xs font-semibold text-gray-400 uppercase tracking-wider">Date & Time</th>
                <th class="px-5 py-3.5 text-xs font-semibold text-gray-400 uppercase tracking-wider">Cashier</th>
                <th class="px-5 py-3.5 text-xs font-semibold text-gray-400 uppercase tracking-wider text-right">Subtotal
                </th>
                <th class="px-5 py-3.5 text-xs font-semibold text-gray-400 uppercase tracking-wider text-right">GST</th>
                <th class="px-5 py-3.5 text-xs font-semibold text-gray-400 uppercase tracking-wider text-right">Grand
                    Total</th>
                <th class="px-5 py-3.5"></th>
            </tr>
        </thead>
        <tbody>
            {% for sale in sales %}
            <tr class="border-b border-gray-800/60 last:border-0 hover:bg-gray-800/30 transition-colors">

                <td class="px-5 py-4">
                    <span class="font-mono text-xs text-brand-400 bg-brand-500/10
                       px-2 py-1 rounded">{{ sale.invoice_number }}</span>
                </td>

                <td class="px-5 py-4 text-gray-300">
                    <p class="font-medium">{{ sale.created_at.strftime('%d %b %Y') }}</p>
                    <p class="text-xs text-gray-500">{{ sale.created_at.strftime('%I:%M %p') }}</p>
                </td>

                <td class="px-5 py-4 text-gray-300">{{ sale.cashier.name }}</td>

                <td class="px-5 py-4 text-right text-gray-400">
                    ₹{{ "{:.2f}".format(sale.total_amount | float) }}
                </td>

                <td class="px-5 py-4 text-right text-gray-500 text-xs">
                    ₹{{ "{:.2f}".format(sale.gst_total | float) }}
                </td>

                <td class="px-5 py-4 text-right font-semibold text-white">
                    ₹{{ "{:.2f}".format(sale.grand_total | float) }}
                </td>

                <td class="px-5 py-4 text-right">
                    <a href="{{ url_for('reports.detail', sale_id=sale.id) }}" class="text-xs px-3 py-1.5 bg-gray-800 hover:bg-gray-700
                    text-gray-300 rounded-lg transition-colors mr-1">
                        View
                    </a>
                    <a href="{{ url_for('billing.reprint', sale_id=sale.id) }}" target="_blank" class="text-xs px-3 py-1.5 bg-indigo-500/10 hover:bg-indigo-500/20
                    text-indigo-400 border border-indigo-500/20 rounded-lg transition-colors" title="Reprint Original">
                        Reprint
                    </a>
                </td>

            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{# ── Pagination ──────────────────────────────────────────────────── #}
{% if total_pages > 1 %}
<div class="flex items-center justify-between">
    <p class="text-xs text-gray-600">Page {{ page }} of {{ total_pages }}</p>
    <div class="flex gap-1">

        {# Previous #}
        {% if page > 1 %}
        <a href="{{ url_for('reports.index', page=page-1, start=start_str, end=end_str, cashier=cashier_id or '') }}"
            class="px-3 py-2 text-xs bg-gray-800 hover:bg-gray-700 text-gray-300 rounded-lg transition-colors">
            ← Prev
        </a>
        {% endif %}

        {# Page numbers — show window of 5 around current page #}
        {% set win_start = [1, page - 2] | max %}
        {% set win_end = [total_pages, page + 2] | min %}
        {% for p in range(win_start, win_end + 1) %}
        <a href="{{ url_for('reports.index', page=p, start=start_str, end=end_str, cashier=cashier_id or '') }}" class="px-3 py-2 text-xs rounded-lg transition-colors
              {% if p == page %}bg-brand-600 text-white
              {% else %}bg-gray-800 hover:bg-gray-700 text-gray-300{% endif %}">
            {{ p }}
        </a>
        {% endfor %}

        {# Next #}
        {% if page < total_pages %} <a
            href="{{ url_for('reports.index', page=page+1, start=start_str, end=end_str, cashier=cashier_id or '') }}"
            class="px-3 py-2 text-xs bg-gray-800 hover:bg-gray-700 text-gray-300 rounded-lg transition-colors">
            Next →
            </a>
            {% endif %}

    </div>
</div>
{% endif %}

{% else %}
{# ── Empty state ─────────────────────────────────────────────────── #}
<div class="bg-gray-900 border border-gray-800 rounded-xl flex flex-col
            items-center justify-center py-20 text-center">
    <div class="w-14 h-14 rounded-2xl bg-gray-800 flex items-center justify-center mb-4">
        <svg class="w-7 h-7 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round"
                d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
    </div>
    <p class="text-gray-400 font-medium mb-1">No sales found</p>
    <p class="text-gray-600 text-sm">
        {% if start_str or end_str or cashier_id %}
        Try adjusting your filters.
        {% else %}
        Complete a sale from the Billing screen to see it here.
        {% endif %}
    </p>
</div>
{% endif %}

{% endblock %}